<html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>incomplete - マイクラで4bitCPU</title><meta content="incomplete" name=keywords><meta content="incomplete - この記事は、大阪工業大学 Advent Calendar 2020の16日目の記事です。
はじめに マインクラフトで4bitCPUを作りました。
実行できる命令はLDIとADDの2種類、レジスタは2個、命令メモリは8個、動作周波数は約0.5Hzです。扱える値は符号なし整数です。レジスタ幅が4bitでLDIのオペランドが2bitの即値を取ることが出来るので0~15（\(2^4\)）の範囲で0~3(\(2^2\))の加算を行うことが出来ます。
  4bitCPU
  4bitCPU CPU 原始的なCPUは以下の部品で作ることが出来ます。
 命令メモリ プログラムカウンタ 全加算器 レジスタファイル ALU（AND、SUB、OR、ADDとかの演算が出来る） セレクタ 符号拡張機  CPUは命令が格納された命令メモリから順番に命令を読み込み、命令を解釈して様々な処理をを行います。一般にCPUでの演算は汎用レジスタ同士で行われます。これはレジスタへのアクセス速度がメモリへのアクセスに比べて非常に早いためです。
今日よく使われているIntelやAMDのx86-64アーキテクチャでは汎用レジスタは16個搭載されています。今回作成した4bitCPUでは汎用レジスタは2つです。
命令セット 命令を作成するために各bitをどのように使うかを決定します。
今回作成した4bitCPUは命令長が4bitです。そのため、今回の設計ではオペランドに1bit、レジスタに1bit割り振りました。よって命令と汎用レジスタ数はそれぞれ2個（\(2^1\)）ずつとなっています。使用出来る命令はADDとLDIです。
   命令 命令機能     ADD Rdest Rdest <- R0 + R1   LDI Rdest, imm2 Rdest <- imm2    ADD命令はレジスタ同士を加算し、レジスタに書き戻します。オペコードは0で、オペランドに書き込み先レジスタ（Rdest）を指定します。普通のCPUであればRdestだけでなくRsrcも指定しますが今回はレジスタが2つしかないので省略しています。
LDI命令は1~3の整数値をレジスタに書き込みます。オペコードが1でオペランドに書き込み先レジスタ（Rdest）と即値を取ります。即値は2bitなので1~3を指定することが出来ます。
   命令 バイナリ表記     ADD R0 0 0 X X   LDI R1, 2 1 1 1 0    命令の表記例です。Xは未使用を表します。" name=description><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/layui/css/layui.css><link rel=stylesheet href=/self/css/default.css><script src=/layui/layui.js></script><link rel=stylesheet async href=/self/css/markdown.min.css><link rel=stylesheet async href=/self/css/gallery.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><script async src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.0/lazysizes.min.js integrity="sha256-h2tMEmhemR2IN4wbbdNjj9LaDIjzwk2hralQwfJmBOE=" crossorigin=anonymous></script></head><body><header class="layui-header layui-bg-cyan"><a href><img src=/images/favicon.png class=layui-nav-img style=margin-left:10px;margin-top:-10px></a>
<a class=nav-self-logo href=/>incomplete</a><ul class="layui-nav layui-layout-right layui-bg-cyan" lay-filter><li class=layui-nav-item id=nav_big><a href=/post/>Posts</a></li><li class=layui-nav-item id=nav_small><a href=javascript:;><i class="layui-icon layui-icon-app" style=font-size:24px></i></a><dl class=layui-nav-child><dd><a href=/post/>Posts</a></dd></dl></li></ul></header><script>layui.use('element',function(){var element=layui.element;});</script><div id=content style=min-height:80%><div class=layui-container style=margin-bottom:10px><div class="layui-row layui-col-space10"><div class="layui-col-md8 layui-col-sm12 layui-col-xs12"><div class="layui-card single-card"><br><blockquote class="self-elem-quote self-elem-quote-bg-red markdown-body single-title"><h1>マイクラで4bitCPU</h1><h3 style=margin-top:10px;margin-bottom:10px><i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i><span>2020-12-14</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i></h3></blockquote><div class="layui-card-body markdown-body single-content"><p>この記事は、大阪工業大学 <a href=https://adventar.org/calendars/5332>Advent Calendar</a> 2020の16日目の記事です。</p><h1 id=はじめに>はじめに</h1><p>マインクラフトで4bitCPUを作りました。<br>実行できる命令は<em>LDI</em>と<em>ADD</em>の2種類、レジスタは2個、命令メモリは8個、動作周波数は約0.5Hzです。扱える値は符号なし整数です。レジスタ幅が4bitで<em>LDI</em>のオペランドが2bitの即値を取ることが出来るので0~15（\(2^4\)）の範囲で0~3(\(2^2\))の加算を行うことが出来ます。</p><figure><img src=/images/4bitcpu/cpu0.png alt=image><figcaption><p>4bitCPU</p></figcaption></figure><h1 id=4bitcpu>4bitCPU</h1><h2 id=cpu>CPU</h2><p>原始的なCPUは以下の部品で作ることが出来ます。</p><ul><li>命令メモリ</li><li>プログラムカウンタ</li><li>全加算器</li><li>レジスタファイル</li><li>ALU（AND、SUB、OR、ADDとかの演算が出来る）</li><li>セレクタ</li><li>符号拡張機</li></ul><p>CPUは命令が格納された命令メモリから順番に命令を読み込み、命令を解釈して様々な処理をを行います。一般にCPUでの演算は汎用レジスタ同士で行われます。これはレジスタへのアクセス速度がメモリへのアクセスに比べて非常に早いためです。<br>今日よく使われているIntelやAMDのx86-64アーキテクチャでは汎用レジスタは16個搭載されています。今回作成した4bitCPUでは汎用レジスタは2つです。</p><h2 id=命令セット>命令セット</h2><p>命令を作成するために各bitをどのように使うかを決定します。</p><p>今回作成した4bitCPUは命令長が4bitです。そのため、今回の設計ではオペランドに1bit、レジスタに1bit割り振りました。よって命令と汎用レジスタ数はそれぞれ2個（\(2^1\)）ずつとなっています。使用出来る命令はADDとLDIです。</p><table><thead><tr><th>命令</th><th>命令機能</th></tr></thead><tbody><tr><td>ADD Rdest</td><td>Rdest &lt;- R0 + R1</td></tr><tr><td>LDI Rdest, imm2</td><td>Rdest &lt;- imm2</td></tr></tbody></table><p>ADD命令はレジスタ同士を加算し、レジスタに書き戻します。オペコードは0で、オペランドに書き込み先レジスタ（Rdest）を指定します。普通のCPUであればRdestだけでなくRsrcも指定しますが今回はレジスタが2つしかないので省略しています。</p><p>LDI命令は1~3の整数値をレジスタに書き込みます。オペコードが1でオペランドに書き込み先レジスタ（Rdest）と即値を取ります。即値は2bitなので1~3を指定することが出来ます。</p><table><thead><tr><th>命令</th><th>バイナリ表記</th></tr></thead><tbody><tr><td>ADD R0</td><td>0 0 X X</td></tr><tr><td>LDI R1, 2</td><td>1 1 1 0</td></tr></tbody></table><p>命令の表記例です。Xは未使用を表します。</p><p>bitの割り振りとしてはオペコードを2bitにして即値を1bitにするほうが実行できる命令の数が増え、汎用性の高いCPUを作ることが出来ましたが実装を簡略化するために今回のような設計にしました。</p><h2 id=組み合わせ回路>組み合わせ回路</h2><p>CPUは沢山の<strong>組み合わせ回路</strong>で構成されます。組み合わせ回路とは<strong>AND回路</strong>や<strong>OR回路</strong>、<strong>NOT回路</strong>などや、これらを組み合わせて作ることが出来る回路のことです。
例えばAND回路、OR回路、NOT回路を組み合わせることで半加算器を作ることができ、半加算器2つとOR回路を組み合わせることで全加算器を作ることが出来ます。<br>マインクラフトにはレッドストーン回路と呼ばれるものがあります。これを用いることで組み合わせ回路を作ることが出来ます。
組み合わせ回路を作ることができればCPUを作ることが出来るわけです。</p><figure class=center><img src=/images/4bitcpu/AND.png alt=image width=500><figcaption><p>AND回路</p></figcaption></figure><figure class=center><img src=/images/4bitcpu/OR.png alt=image width=500><figcaption><p>OR回路</p></figcaption></figure><h2 id=回路>回路</h2><p>先ほど決めた命令にしたがって計算できるように回路を作成します。</p><p>回路の実装は以下のようになりました。
先ほど説明した原始的なCPUと異なる点として、実装を簡単にするためにプログラムカウンタの代わりにシフトレジスタを使いました。また命令が2つしかないのでALUの代わりに全加算器を用い、セレクタで命令を判定しています。 配線は白がクロック、赤がリセットです。命令メモリにはレバーで命令を手打ちします。</p><p>回路はクロックに同期して命令メモリの命令を順番に実行します。黄色い枠のセレクタは命令のオペランドで書き込む値の選択を行い、水色の枠のセレクタは書き込み先レジスタを選択します。</p><figure class=center><img src=/images/4bitcpu/kairo.png alt=image><figcaption><p>4bitCPU</p></figcaption></figure><p>さいごに実際に計算を行います。</p><table><thead><tr><th>命令</th><th>バイナリ表記</th><th>R0（予測値）</th><th>R1（予測値）</th></tr></thead><tbody><tr><td>LDI R0, 01</td><td>1001</td><td>0001</td><td>0000</td></tr><tr><td>LDI R1, 10</td><td>1110</td><td>0001</td><td>0010</td></tr><tr><td>ADD R0</td><td>00XX</td><td>0011</td><td>0010</td></tr><tr><td>LDI R2, 11</td><td>1111</td><td>0011</td><td>0011</td></tr><tr><td>ADD R0</td><td>00XX</td><td>0110</td><td>0011</td></tr><tr><td>ADD R0</td><td>00XX</td><td>1001</td><td>0011</td></tr></tbody></table><p>左の4つの明かりがR0、右の4つのあかりがR1です。明かりがついているときが1で消えているときが0に対応します。
正しく計算が行われていることがわかると思います。</p><figure class=center><img src=/images/4bitcpu/reg.gif alt=image><figcaption><p>register</p></figcaption></figure><h1 id=おわりに>おわりに</h1><p>今回作成したCPUは非常に単純なものでしたが実際に計算を行うことが出来ました。回路の動作が目に見える形で実行され計算が行われるのは見ていて面白かったです。</p><p>CPUに興味の湧いた方や気になる方が入れば下記のサイト上で簡単なCPUが作れるみたいなので遊んでみるといいと思います。</p><ul><li><a href=http://nandgame.com/>http://nandgame.com/</a></li></ul><h1 id=参考記事>参考記事</h1><ul><li><a href=https://w.atwiki.jp/minecraft/pages/26.html>https://w.atwiki.jp/minecraft/pages/26.html</a></li></ul></div></div></div><div class="layui-col-md4 layui-col-sm12 layui-col-xs12"><div class="layui-card single-card"><h2 class=single-title>Recent Posts</h2><div style=margin-left:10px><blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px><a href=/post/abc186/><h3>ABC186</h3></a><h3 style=margin-top:10px;margin-bottom:10px><i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i><span>2020-12-20</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i><a href=/tags/atcoder/><span class="layui-badge layui-bg-orange" style=vertical-align:2px>atcoder</span></a></h3></blockquote></div><div style=margin-left:10px><blockquote class="self-elem-quote self-elem-quote-bg-red" style=background-color:#fff;margin-top:10px><a href=/post/%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%A9%E3%81%A74bitcpu/><h3>マイクラで4bitCPU</h3></a><h3 style=margin-top:10px;margin-bottom:10px><i class="layui-icon layui-icon-date" style=font-size:28px;vertical-align:-2px></i><span>2020-12-14</span>
<i class="layui-icon layui-icon-tabs" style=font-size:22px;vertical-align:1px;margin-right:2px></i></h3></blockquote></div><br></div></div></div></div></div><footer><div class=layui-container><div class=layui-row><div class="layui-col-md4 layui-col-sm6 layui-col-xs6"><h3>Related Sites</h3></div></div><div class=layui-row><div class="layui-col-md4 layui-col-sm6 layui-col-xs12"><a href=/><p class=footer-url>home</p></a></div></div></div><div class=layui-container><p class=copyright>&copy; All rights reserved. Powered by <a href=https://gohugo.io style=color:#fff>Hugo</a> and <a href=https://github.com/ertuil/erblog style=color:#fff>Erblog</a>.</p></div></footer></body></html>